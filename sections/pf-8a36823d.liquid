<link rel="stylesheet" href="https://cdn.shopify.com/s/files/1/0583/5810/4213/files/laydatev3.css">
<link rel="preload" href="https://cdn.shopifycdn.net/s/files/1/0633/2068/6808/files/20230607-142007.jpg?v=1686118943" as="image">
{{ 'testride.scss.css' | asset_url | stylesheet_tag }}

<style>
    .carousel {
        margin-top: 40px;
        margin-bottom: 120px;
    }
    .carousel .u36DemiBold_v2 {
        margin-bottom: 25px;
    }
    .carousel .jdgm-carousel-wrapper {
        width: 100%;
        margin: unset;
        background-color: #f7f8fa;
    }
    @media (max-width: 767px) {
        .carousel {
            padding: 0 4vw;
            margin-top: 0;
            margin-bottom: 60px;
        }
        .carousel .jdgm-carousel-wrapper {
            padding: 10px 0;
        }
        
        .carousel .jdgm-carousel__item-wrapper {
            height: auto;
        }
        .carousel .jdgm-carousel__item-wrapper .jdgm-carousel-item__image-wrapper {
            height: 40vw;
        }
        .carousel .jdgm-carousel__item-wrapper .jdgm-carousel-item__product-image {
            object-fit: cover;
        }
        .carousel .u36DemiBold_v2 {
            font-size: 24px;
            margin-bottom: 15px;
        }

        .carousel .jdgm-carousel--focused-theme .jdgm-carousel-item__review-rating {
            text-align: center;
        }
    }
</style>

<div class="testride">
    <div class="map" id="map">
        <div class="centeral-content">
            <div class="u36DemiBold_v2">Choose your test ride location</div>
            <div class="u17Medium_v2">Take your first step in to experience the stunning appearance and smooth riding. Book a test ride today with our partners and ambassadors! Their extensive expertise and enthusiasm will help you out with any questions in and out.</div>
            <div id="storepoint-container" data-tags="us,ca" data-map-id="162f21804990ff"></div>
            <div class="u14Medium_v2 swiper-pagination pcHide"></div>
            <img src="https://cdn.shopify.com/s/files/1/0583/5810/4213/files/Group_22705_2x_4a2775a6-fd27-4a93-9b51-73108206acf0.jpg?v=1701930274" class="swiper-button-prev pcHide"/>
            <img src="https://cdn.shopify.com/s/files/1/0583/5810/4213/files/Group_22705_2x_4a2775a6-fd27-4a93-9b51-73108206acf0.jpg?v=1701930274" class="swiper-button-next pcHide"/>
        </div>
    </div>
    <div class="centeral-content carousel">
        <div class="u36DemiBold_v2">Let customers speak for us</div>
        {% include 'judgeme_widgets', widget_type: 'judgeme_featured_carousel', concierge_install: false, auto_install: false %}
        </div>
    <div class="explained">
        <div class="centeral-content">
            <div class="u36DemiBold_v2">Test ride <br>options explained</div>
            <div class="item">
                <img src="https://cdn.shopify.com/s/files/1/0633/2068/6808/files/Zweiradhaus_Ehrig1_cbf8016a-6cd0-4d36-9b43-1155c58a26a3.jpg?v=1698146438"
                    alt="">
                <div class="title">
                    <img src="https://cdn.shopify.com/s/files/1/0633/2068/6808/files/shop_2x_21db8206-c4af-4fe9-98e5-a23ed770e4e8.png?v=1680587063"
                        alt="">
                    <span class="u20DemiBold_v2">Partner Store</span>
                </div>
                <div class="u17Light_v2">There you can view and test ride our e-bike models, get in-person advice from
                    our e-bike experts.
                    We even have in-stock models ready for immediate purchase.</div>
            </div>
            <div class="item">
                <img src="https://cdn.shopify.com/s/files/1/0633/2068/6808/files/20221005-untitled-9056_2x_1a6940cb-42b6-4047-9c86-b70dda745f36.jpg?v=1680587516"
                    alt="">
                <div class="title">
                    <img src="https://cdn.shopify.com/s/files/1/0633/2068/6808/files/user_2x_1ee32fa1-d94b-4eda-be5e-deb33536a73b.png?v=1680587584"
                        alt="">
                    <span class="u20DemiBold_v2">Ambassadors</span>
                </div>
                <div class="u17Light_v2">Ambassadors are Urtopia representatives who are passionate about our e-bikes.
                    While an ambassador may not have every model on hand they are there to meet you to show you the ins
                    and outs of our bikes. They offer real insight into the benefits of being a daily e-bike user.<br>
                    <!--<a class="my-link" href="#stories">Read the story</a>--></div>
            </div>
        </div>
    </div>
    <div class="howto">
        <div class="centeral-content">
            <div class="u36DemiBold_v2">How to Test Ride</div>
            <div class="items">
                <div class="item">
                    <img src="https://cdn.shopify.com/s/files/1/0633/2068/6808/files/bike_2x_eb308ea1-7fa7-4dc7-8e95-4b7bf28fe06a.png?v=1702030645"
                        alt="">
                    <span class="u20DemiBold_v2">Pick your model</span>
                    <span class="u17Light_v2">Choose your favorite model and be aware of the available size, so we could prepare the right bike for you.</span>
                </div>
                <div class="item">
                    <img src="https://cdn.shopify.com/s/files/1/0633/2068/6808/files/search_2x_6ca44257-1d7b-47ce-ba6a-fef435c9b47f.png?v=1702030663"
                        alt="">
                    <span class="u20DemiBold_v2">Search your location</span>
                    <span class="u17Light_v2">Pick a store or ambassador near your location. Contact us at support@newurtopia if you can’t find a spot works for you.</span>
                </div>
                <div class="item">
                    <img src="https://cdn.shopify.com/s/files/1/0633/2068/6808/files/booking-2_2x_9223282e-c6ac-4785-87d7-f8fa9bdeb492.png?v=1680588590"
                        alt="">
                    <span class="u20DemiBold_v2">Schedule a time</span>
                    <span class="u17Light_v2">Make a call at the opening hours to schedule your available date and time, as well as your favorite model.</span>
                </div>
                <div class="item">
                    <img src="https://cdn.shopify.com/s/files/1/0633/2068/6808/files/bike_2x_b310fe93-d3f0-4623-9ffd-91265fb9abf2.png?v=1680588485"
                        alt="">
                    <span class="u20DemiBold_v2">Ride it out</span>
                    <span class="u17Light_v2">Learn all about Urtopia bikes, make the most of your test ride. Trust us, you'll want all the time that you can get.</span>
                </div>
            </div>
        </div>
    </div>

    <!--<div class="stories" id="stories">
        <div class="centeral-content">
            <div class="u36DemiBold_v2">Ambassadors‘ Stories</div>
            <div class="content">
                <div>
                    <div class="u20DemiBold_v2">Henky’s Sightseeing Adventure</div>
                    <div class="u17Light_v2">He’s all about showing locals the Urtopia e-bike. living in a city with two thousand years of history, home to world-renowned landmarks like the Catholic Cologne Cathedral and a plethora of cultural and artistic hubs, Henky has a thing for pedaling his Urtopia through the city, eyes wide open for the best views. He loves to snap pictures of his Urtopia, perfectly posed against gorgeous landscapes.</div>
                    <a class="my-link" href="/blogs/blog/henky-s-story">Read the story</a>
                </div>
                <div></div>
            </div>
        </div>
    </div>-->
    <div class="whatto">
        <div class="centeral-content">
            <div class="u36DemiBold_v2">What to experience</div>
            <div class="u17Light_v2">From the effortless power of the electric motor to the comfortable and stylish
                design, experience the thrill for yourself by booking a test ride today!</div>
            <div class="videos">
                <div>
                    <video muted playsinline autoplay loop
                        src="https://player.vimeo.com/progressive_redirect/playback/814462353/rendition/1080p/file.mp4?loc=external&signature=11383a8e982e4f086f6b10b252f533c2841151e1cf6f9f5feeefaf79431cd15c"></video>
                </div>
                <div>
                    <span class="u20DemiBold_v2 mobileHide">Full Carbon Fiber <br> Weight only 15 kg</span>
                    <span class="u20DemiBold_v2 pcHide">Full Carbon Fiber <br> Weight only 15 kg</span>
                    <span class="u20DemiBold_v2">Try the advantage <br> of a lightweight e-bike</span>
                    <video muted playsinline autoplay loop
                        src="https://player.vimeo.com/progressive_redirect/playback/814462300/rendition/1080p/file.mp4?loc=external&signature=35b1c5e5b7c43b3e18e042ebe5593b25890c8d8af27c31f0cb73ca5dd9483dd7"></video>
                    <span class="u20DemiBold_v2">The riding experience <br> will not let you down</span>
                </div>
            </div>
        </div>
    </div>
    <!--<div class="smart">
        <div class="centeral-content">
            <div>
                <span class="u20DemiBold_v2">Smart</span>
                <span class="u36DemiBold_v2">Elevate<br class="mobileHide"> Your Ride</span>
                <span class="u17Light_v2">Explore with a customized smart partner: talk, navigate, and never lose track
                    of the bike.</span>
                <a class="my-button my-button-black" href="#map">Book a free test ride</a>
            </div>
            <img class="pcHide"
                src="https://cdn.shopify.com/s/files/1/0633/2068/6808/files/Group_20473_2x_ec77d911-5440-468e-a1c9-9b50497550e5.jpg?v=1680597546"
                alt="">
            <div class="mobileHide">
                <img src="https://cdn.shopify.com/s/files/1/0633/2068/6808/files/Group_20834_2x_e92f1711-9e53-401b-a684-f9d6babe870b.png?v=1680595868"
                    alt="">
                <div></div>
            </div>
        </div>
    </div>-->
    <div class="notin">
        <div style="flex: 1;">
            <div class="centeral-content">
                <span class="u36DemiBold_v2">Not in your city?</span>
                <span class="u17Light_v2">We got you covered, contact us for more test ride opportunity, or just visit
                    one of our partner store to test ride.</span>
                <div class="buttons">
                    <a class="my-button" href="/pages/contactus">Contact us</a>
                    <a class="my-button" href="/pages/find-a-dealer">Find a dealer</a>
                </div>
            </div>
        </div>
    </div>
    <div class="faqs">
        <div class="centeral-content">
            <div class="faq">
                <div class="titlee">Test-ride FAQs</div>
                <div class="swiper swiper-no-swiping faq-list">
                    <div class="swiper-wrapper">
                        <div class="swiper-slide">
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div id="urtopia-calendar"></div>
    <dialog id="item_detail" class="item_detail"></dialog>
</div>

{{ 'laydatev4-us.js' | asset_url | script_tag }}
<script src="https://cdn.storepoint.co/api/v1/js/162f21804990ff.js"></script>
<script>

    const start_time = +new Date()
    let loaded_worker = 0
    let testRides = new Map()
    let bike_options = new Set()
    let country_group = {}
    let search = {}
    let swiperrrrrrrrrrrrrrr = null
    let swiperrrrrrrrrrrrrrrTop = 0
    const u = new URL(location.href)

    for (const [k, v] of u.searchParams.entries()) {
        search[k] = v
    }

    const worker = new Worker('{{ 'shopInfoList-us.js' | asset_url }}')
    worker.onmessage = function (e) {
        testRides = e.data.store_list
        bike_options = e.data.bike_options
        country_group = e.data.country_group

        loaded_worker = +new Date() - start_time

        search.name && booknow(search.name)

        //$('.test-ride-new-banner .buttons').show()
    }

    let last_select_city = ''
    let last_select_store = ''
    let select_city_count = 0
    let select_store_count = 0
    let store_list_render_total_time = 0
    
    
    const findStore = name => testRides.get(name.replace(/\s*/g, ""))
    
      function CalendarOpen(shopPoint, shop, isSpecDay = false, timetp = 0) {
        console.log(arguments)
    
        laydate.render({
          elem: '#urtopia-calendar',
          lang: 'en',
          min: 0,
          max: 90,
          showBottom: false,
          position: "static",
          showSide: true,
          showInfoBottom: true,
          type: 'date',
          shopList: typeof shop === 'string' ? JSON.parse(shop.replace(/'/g, '"')) : shop,
          isSpecDay,
          TimePeriodization: timetp,
          //  shopInfo: shopInfo
        });
      }
    
    
      function booknow (name) {
        const store = typeof name === 'object' ? name : findStore(name)
    
        if (!store) {
          return
        }

        
        CalendarOpen(store.testrideSpot, { [store['phone']]: store })

        fetchBuried('testride', 'booknow', { store_name: name })
      }

      function showContactInfo (name) {
        const store = findStore(name)
        console.log('store', store)
        if (!store) {
            return
        }
        const item_detail = document.getElementById('item_detail')
        $(item_detail).html(storeInfoHtml(store))
        showDialog(item_detail)
      }


      const faqs = [
        {
            title: 'How to book a test ride?',
            content: `We know how important it is for you to test out the bike before you purchase it, therefore we build a system that you can easily book a test ride or find a test ride spot that best suit you.<br><br> Navigate to the below pages:<br> <a href="#map">Test Ride</a> <br><a href="/pages/find-a-dealer">Find a Store</a> <br><br> In the test ride page, you start with choosing your city, we are doing our best try to expand the our test ride locations, then fill in your informations and select a time that suit you the best. That’s all you need to book a test ride. After that you will receive a confirmation email, and you might receive a call from us to collect more details for your best experience. <br><br>In the Find a Store page, you can find all the Test Ride spot by choosing “Test Ride” in Store Service, you don’t need to book while going to these spot, but we highly recommend you to give the store a call before you go.<br><br> If you can not find a spot that works for you, please contact us at support@newurtopia , we will try our best to organise you a test ride.`
        },
        {
            title: 'What to expect when attending a test ride?',
            content: `The step is fairly simple, all our test ride spot is trained to answer any of your questions and will guide you through the process, the general step is like list below:<br><br>
                        <ul style="padding-inline-start: 5%;">
                        <li>Meet our expert: Bring nothing other than your curiosity. </li>
                        <li>Have fun riding the bike, and try all the functions, experience the bike in and out.</li>
                        </ul>`
        }
    ]

    $('.faqs .swiper-slide').html(faqs.map(faq => `
      <div class="faq-item">
         <div class="faq-title">
           <span>${faq.title}</span>
           <i class="faq-content-plus"></i>
         </div>
         <div class="faq-content">${faq.content}</div>
      </div>`).join(''))


    setTimeout(() => {
        $('.faq-title').click(function () {
            $(this)
                .siblings('.faq-content')
                .slideToggle()
                .parent()
                .siblings()
                .find('.faq-content')
                .slideUp();
            $(this).children('i').toggleClass('faq-content-plus');
            $(this)
                .parent()
                .siblings()
                .find('.faq-title')
                .children('i')
                .addClass('faq-content-plus');
        });
    }, 300)


    function storeInfoHtml (info) {
        const tags = info.tags || [{ color: 'gray', text: info.isPartner ? 'Ambassadors' : 'Partner Store' }]
        const noBook = typeof info.noBook === "string" ? info.noBook : 'Please contact the Ambassadors directly to arrange test ride'
        const href = $('#storepoint-map .storepoint-location-popup .storepoint-popup-directions').attr('href') || `https://www.google.com/maps/dir/${info.add}`
        const weeks = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday']
        return `
                <div class="close u17Light_v2 back"><i><svg class="icon" style="width: 1em;height: 1em;vertical-align: middle;fill: currentColor;overflow: hidden;" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="5533"><path d="M748.3 533.3c0.1-0.2 0.3-0.4 0.4-0.6 0.2-0.3 0.5-0.7 0.7-1 0.1-0.1 0.2-0.3 0.2-0.4 0.3-0.4 0.5-0.8 0.8-1.2l0.1-0.1c2.6-4.6 4.1-9.6 4.6-14.7v-0.2c0-0.5 0.1-0.9 0.1-1.4v-0.6-1-1-0.6c0-0.5-0.1-0.9-0.1-1.4v-0.2c-0.4-5.1-2-10.1-4.6-14.7l-0.1-0.1c-0.2-0.4-0.5-0.8-0.8-1.3-0.1-0.1-0.2-0.3-0.2-0.4-0.2-0.3-0.4-0.7-0.7-1-0.1-0.2-0.3-0.4-0.4-0.6-0.2-0.3-0.4-0.5-0.6-0.8-0.2-0.2-0.4-0.5-0.6-0.7-0.1-0.1-0.2-0.2-0.3-0.4-0.1-0.1-0.2-0.2-0.2-0.3-0.2-0.3-0.5-0.5-0.7-0.8-0.2-0.2-0.4-0.4-0.5-0.6l-0.7-0.7-0.6-0.6c-0.2-0.2-0.5-0.4-0.7-0.7l-0.6-0.6-0.3-0.3-414.6-347.6c-15.2-12.7-38-10.7-50.7 4.4-12.7 15.2-10.7 38 4.4 50.7L663.2 512 281.6 832.2c-15.2 12.7-17.2 35.6-4.4 50.7 12.7 15.2 35.6 17.2 50.7 4.4l414.4-347.7 0.3-0.3 0.6-0.6c0.2-0.2 0.5-0.4 0.7-0.7l0.6-0.6 0.7-0.7c0.2-0.2 0.4-0.4 0.5-0.6 0.2-0.3 0.5-0.5 0.7-0.8 0.1-0.1 0.2-0.2 0.2-0.3 0.1-0.1 0.2-0.2 0.3-0.4 0.2-0.2 0.4-0.5 0.6-0.7 0.4-0.1 0.6-0.4 0.8-0.6z" fill="#333333" p-id="5534"></path></svg></i> Back</div>
                <img src="${info.imgUrl}&width=350" class="pcHide"/>
                <div class="u17DemiBold_v2">${info.name}</div>
                <div class="tags">${tags.map(t => `<span class="u14DemiBold_v2 tag-${t.color}">${t.text}</span>`).join('')}</div>
                <div class="infossssss">
                    <div>
                        <span class="u14DemiBold_v2">Email:</span>
                        <span class="u14Light_v2">${info.email}</span>
                    </div>
                    <div>
                        <span class="u14DemiBold_v2">Phone:</span>
                        <span class="u14Light_v2">${info.phone}</span>
                    </div>
                    <div>
                        <span class="u14DemiBold_v2">Add:</span>
                        <span class="u14Light_v2">${info.add}</span>
                    </div>
                </div>
                ${info.noBook ? `<div class="u14DemiBold_v2">${noBook}</div>` : ''}
                <div class="buttons">
                    ${!info.noBook ? `<a class="close my-button my-button-black" onclick="booknow('${info.name}')">Book Now</a>` : ''}
                    <a class="my-button my-button-white" style="margin-left: 6px;" target="_blank" href="${href}">Direction</a>
                </div>
                ${info.tagsText.length ? `<div class="ulli">
                    <span class="u14DemiBold_v2">Services:</span>
                    <ul class="u14Light_v2">
                        ${ info.tagsText.map(i => `<li>${i}</li>`).join('') }
                    </ul>
                </div>` : ''}
                <div class="ulli">
                    <span class="u14DemiBold_v2">Available Test bikes:</span>
                    <ul class="u14Light_v2">
                        ${info.availableSizes ? info.availableSizes.map(i => `<li>${i}</li>`).join('') : `<li>Carbon One Size ${info.testRideSize}</li>`}
                    </ul>
                </div>
                <div class="opening">
                    <span class="u14DemiBold_v2">Opening hours:</span>
                    ${info.businessHours.map((b, i) => `<div class="u14Light_v2">
                        <span>${weeks[i]}</span>
                        <span>${b || 'closed'}</span>
                    </div>`).join('')}
                </div>
                `
    }

    function reset() {
        $('#storepoint-search .forms select').val('')
        custom_tags = []

        // STOREPOINT.set_tags(['DE'])
        STOREPOINT.reset()
        document.querySelector('.storepoint-tag-checkbox[value="us"]').click()
        document.querySelector('.storepoint-tag-checkbox[value="test%20bikes"]').click()
        
    }

    const default_tags = ['us', 'Test bikes']
    let custom_tags = []

    function refresh(index, tag) {
        // 先覆盖先有的值
        custom_tags[index] = tag

        // 然后再合并
        const tags = default_tags.slice(0).concat(custom_tags.slice(0)).filter(Boolean)
        if (tags.length === 2 && !$('.mapboxgl-ctrl-geocoder--input').val()) {
            return reset()
        }

        STOREPOINT.set_tags(tags)
        STOREPOINT.reload_locations()
    }


    const observerElement = (selector, callback) => {
        // 观察器的配置（需要观察什么变动）
        const config = { childList: true };
        const targetNode = document.querySelector(selector)

        return new Promise(resolve => {
            // 创建一个观察器实例并传入回调函数
            (new MutationObserver((mutationsList, observer) => {
                // 是否回调函数，如果有需要持续监听，如果没有就中断
                if (callback) {
                    callback(mutationsList)
                } else {
                    observer.disconnect()
                }

                resolve(targetNode)
            })).observe(targetNode, config);
        })
    }

    function onSelect(e) {
        //e.srcElement && reset()

        const city = e.target.value

        refresh(0, city)


        if (city) {
            last_select_city = city
            select_city_count += 1
        }
    }

    function onSelectBike (e) {
        const bike = e.target.value

        refresh(1, bike)
    }

    function onInput(e) {
        const select = document.querySelector('#storepoint-search .forms select')

        if (select.value) {
            select.value = ''
            // select.style.color = '#a1a1a1'
            onSelect({
                target: select
            })
        }

        const value = e.target.value
    }

    function onFocus() {
        // const input = document.querySelector('.mapboxgl-ctrl-geocoder--input')

        // if (!input.value) {
        //     reset()
        // }
    }

    function insertCustomElements(target, count = 0) {
        loaded_map = +new Date() - start_time
        loaded_list = +new Date()

        // 如果 worker 还没加载完成, 300s 重复调用, 止到调用10次
        if (loaded_worker === 0 && count < 10) {
            return setTimeout(insertCustomElements, 300, target, ++count)
        }

        if (testRides.size) {
            target.style.opacity = 0
        }

        const storeList = $(document.createDocumentFragment())
        const forms = $(document.createDocumentFragment())

        // 商店列表
        const items = $(document.createElement("div"))
        const no_result = $(document.createElement('div'))
        const item_detail = $(document.createElement('div'))
        items.addClass('items swiper-wrapper')
        no_result.addClass('no_result')
        item_detail.addClass('item_detail mobileHide')
        no_result.html(`<div>No locations found near you</div><div>but we'd love to change that. </div><div class="my-link" onclick="reset()">Show all results?</div>`)

        // 搜索父表单
        const form = $(document.createElement("div"))
        form.addClass('forms')

        // 选择框
        const select = $(document.createElement('select'))
        select.attr('placeholder', '')
        // 首选项
        const option = $(document.createElement('option'))
        // option.setAttribute('disabled', true)
        option.attr('selected', true)
        option.attr('value', '')
        option.text('--- Select your city ---')

        select.append(option)

        // 车型选择框
        const bike_select = $(document.createElement('select'))
        bike_select.attr('placeholder', '')

        const bike_option = $(document.createElement('option'))
        bike_option.attr('selected', true)
        bike_option.attr('value', '')
        bike_option.text('--- Select bike ---') 

        bike_select.append(bike_option)

        // form.appendChild(input)
        form.append(select)
        form.append(bike_select)

        select.on('change', onSelect)
        bike_select.on('change', onSelectBike)
        $('button[aria-label="Clear"]').on('click', () => refresh(2))

        const sortedItems = new Array(3)
        $('.storepoint-location').each((i, store) => {
            const elem = $(store).find('.storepoint-name')

            const name = elem.text()
            const info = findStore(name)
            // 如果搜不到 店铺
            if (!info) {
                return true
            }



            const item = $(document.createElement("div"))

            item.addClass('item swiper-slide')
            item.attr('index', elem.attr('id'))
            item.attr('city', info.testrideSpot)
            item.attr('name', info.name)

            item.html(info.html)

            const tags = $(store).find('.storepoint-tags > .tag-repairsandservicing, .storepoint-tags > .tag-testbikes, .storepoint-tags > .tag-shoppingandadvising')
            info.tagsText = []
            if (tags.length) {
                const tagsDiv = $(document.createElement("div"))
                tagsDiv.addClass('ulli')
                
                tags.each(function(){
                    info.tagsText.push($(this).find('.tag-text').text())
                })
                tagsDiv.html(`
                    <span class="u14DemiBold_v2">Services:</span>
                    <ul class="u14Light_v2">
                        ${ info.tagsText.map(i => `<li>${i}</li>`).join('') }
                    </ul>`)
                setTimeout(() => {
                    item.find('.ulli').before(tagsDiv)
                })
            }
            
            // 点击item 代理到真实的store
            item.on('click', (e, extra) => {
                if (global_config.is_mobile) {
                    e.preventDefault()
                    return false
                }

                const active = $('#storepoint-panel .items .item[active="true"]')
                const locations = $('#storepoint-results-container .storepoint-location')

                if (active.length) {
                    active.attr('active', false)
                }


                !extra && locations.each((i, elemm) => {
                    const iterator = $(elemm)
                    iterator.removeClass('selected')
                    if (item.attr('name').replace(/\s*/g, "") === iterator.find('.storepoint-name').text().replace(/\s*/g, "")) {
                        iterator.addClass('selected')
                        iterator[0].click()

                        return false
                    }
                })

                item_detail.html(storeInfoHtml(info))
                item_detail.css('visibility', 'visible')
                item_detail.find('.back').on('click', () => item_detail.css('visibility', 'hidden'))

                item.attr('active', true)

                document.body.clientWidth < 768 && $('html').scrollTop($('.map').offset().top)

                last_select_store = item.attr('name')
                select_store_count += 1
            })

            if (typeof info.sort === 'number' && !sortedItems[info.sort]) {
                sortedItems[info.sort] = item
            } else {
                items.append(item)
            }
        })

        for (const country in country_group) {
            const group = $(document.createElement('optgroup'))
            const citys = country_group[country]

            group.attr('label', country)

            for (const city of citys) {
                const option = $(document.createElement('option'))
                option.text(city)
                option.attr('city', city)
                option.attr('country', country)

                group.append(option)
            }

            select.append(group)
        }

        bike_options.forEach(option => {
            const bike_option = $(document.createElement('option'))
            bike_option.text(option)
            bike_option.attr('bike', option)

            bike_select.append(bike_option)
        })


        // items 前面插入置顶店铺
        for (const item of sortedItems) {
            item && items.prepend(item)
        }

        storeList.append(items)
        storeList.append(no_result)
        forms.append(form)

        if (testRides.size) {
            $(target).parent().append(storeList)
            $('#storepoint-search').append(forms)
            $(target).parent().parent().append(item_detail)

            setTimeout(() => {
                global_config.is_mobile && (swiperrrrrrrrrrrrrrr = new Swiper('#storepoint-panel', {
                        // effect: 'fade',
                        // fadeEffect: {
                        //     crossFade: true
                        // },
                        spaceBetween : '4%',
                        pagination: { el: '.map .centeral-content .swiper-pagination', type: "fraction" },
                        navigation: {
                            nextEl: '.map .centeral-content .swiper-button-next',
                            prevEl: '.map .centeral-content .swiper-button-prev',
                        },
                        speed: 300,
                        on: {
                            slideChange: v => {
                                const t = $('html').scrollTop()
                                $('#storepoint-panel .items .item').filter(function (params) {
                                    return $(this).css('display') !== 'none'
                                }).each((i, elem) => {
                                    if (i === v.realIndex) {
                                        const locations = $('#storepoint-results-container .storepoint-location')
                                        locations.each((i, elemm) => {
                                            const iterator = $(elemm)
                                            iterator.removeClass('selected')
                                            if ($(elem).attr('name').replace(/\s*/g, "") === iterator.find('.storepoint-name').text().replace(/\s*/g, "")) {
                                                iterator.addClass('selected')
                                                iterator[0].click()
                                                $('html').scrollTop(t)
                                                return false
                                            }
                                        })
                                        return false
                                    }
                                })
                            }
                        }
                    }))
            }, 100)
        }


        fetchBuried('testride', 'performance', {
            loaded_worker: `${loaded_worker} ms`,
            loaded_map: `${loaded_map} ms`,
            loaded_list: `${+new Date() - loaded_list} ms`,
            userAgent: navigator.userAgent,
            userAgentData: navigator.userAgentData,
        })
    }

    function observerItems(mutationsList) {
        const no_result = document.querySelector('#storepoint-panel .no_result')
        no_result.style.display = 'none'

        const results = $('#storepoint-results-container .storepoint-location')
        

        $('#storepoint-panel .items .item').each((_, e) => {
            const iterator = $(e)
            iterator.hide()

            results.each((__, ee) => {
                const result = $(ee)

                const name1 = result.find('.storepoint-name').text() || ''
                const name2 = iterator.attr('name') || ''

                if (name1.replace(/\s*/g, "") === name2.replace(/\s*/g, "")) {
                    iterator.show()
                    return false
                }
            })
        })

        if (results.length === 0 && document.querySelector('#storepoint-results-container .storepoint-no-results')) {
            no_result.style.display = 'flex'
        }

        global_config.is_mobile && swiperrrrrrrrrrrrrrr && setTimeout(() => {
            swiperrrrrrrrrrrrrrr.update({ updateTranslate: true })
            setTimeout(() => swiperrrrrrrrrrrrrrr.slideTo(0))
        })
    }

    function observerPopup() {
        const popup = $('#storepoint-map .mapboxgl-popup')

        if (!popup.length) {
            return
        }

        const store = findStore($('#storepoint-map .storepoint-location-popup b').text())

        if (!store) {
            return
        }

        popup.find('.mapboxgl-popup-content').hide()

        const href = $('#storepoint-map .storepoint-location-popup .storepoint-popup-directions').attr('href')

        const noBook = typeof store.noBook === "string" ? store.noBook : 'Please contact the Ambassadors directly to arrange test ride'

        const tags = store.tags || [{ color: 'gray', text: store.isPartner ? 'Ambassadors' : 'Partner Store' }]
        if (swiperrrrrrrrrrrrrrr) {
            $('#storepoint-panel .items .item').filter(function (params) {
                return $(this).css('display') !== 'none'
            }).each((i, elem) => {
                if ($(elem).attr('name').replace(/\s*/g, "") === store.name.replace(/\s*/g, "")) {
                    swiperrrrrrrrrrrrrrr.slideTo(i)
                    return false
                }
            })
        } else {
            $('#storepoint-panel .items .item').each(function () {
                if ($(this).attr('name').replace(/\s*/g, "") === store.name.replace(/\s*/g, "")) {
                    $(this).trigger('click', 'xxxxxx')

                    setTimeout(() => {
                        $('#storepoint-panel .items').scrollTop($(this)[0].offsetTop)
                    }, 300)

                    return false
                }
            })
        }
        
        return popup.append(`
            <div class="map-popup">
                <img src="${store.imgUrl}&width=350"/>
                <div class="u17DemiBold_v2">${store.name}</div>
                <div class="tags">${tags.map(t => `<span class="u14DemiBold_v2 tag-${t.color}">${t.text}</span>`).join('')}</div>
            </div>
        `)

        if (store.noBook) {
            popup.append(`
                <div class="map-popup">
                    <img src="${store.imgUrl}"/>
                    <div class="infos nobook">
                        <div class="name">${store.name}</div>
                        <div class="available">Available Model:</div>
                        <ul>
                            ${store.availableSizes ? store.availableSizes.map(i => `<li class="gray">${i}</li>`).join('') : `<li class="gray">Carbon One Size ${store.testRideSize}</li>`}
                        </ul>
                        <div class="contact">
                            <div>
                                <span class="u14DemiBold_v2">Email: </span>
                                <span class="u14Light_v2">${store.email}</span>
                            </div>
                            <div>
                                <span class="u14DemiBold_v2">Phone: </span>
                                <span class="u14Light_v2">${store.phone}</span>
                            </div>
                            <div>
                                <span class="u14DemiBold_v2">Add: </span>
                                <span class="u14Light_v2">${store.add}</span>
                            </div>
                        </div>
                        <div class="u14DemiBold_v2">${noBook}</div>
                    </div>
                </div>
            `)

        } else {
            popup.append(`
                <div class="map-popup">
                    <img src="${store.imgUrl}"/>
                    <div class="infos">
                        <div class="name">${store.name}</div>
                        ${store.stories? `<a href="${store.stories.blogUrl}" class="address gray my-link">${store.stories.urlText}</a><div class="available" style="margin-bottom: -6px;">Add:</div>` : ''}
                        <div class="address gray">${store.add}</div>
                        <div class="available">Available Model:</div>
                        <ul>
                            ${store.availableSizes ? store.availableSizes.map(i => `<li class="gray">${i}</li>`).join('') : `<li class="gray">Carbon One Size ${store.testRideSize}</li>`}
                        </ul>
                        <div class="time gray"><img src="https://cdn.shopify.com/s/files/1/0633/2068/6808/files/calendar_2x_af8d9192-1ff9-43f0-aba6-3547b1129854.jpg?v=1680938382"/> Earliest available time: <div>&nbsp;${store.avalibaleDate}</div></div>
                        <div class="buttons">
                            <a class="my-button my-button-black" onclick="booknow('${store.name}')">Book Now</a>
                            <a class="my-button my-button-white" style="margin-left: 6px;" target="_blank" href="${href}">Direction</a>
                        </div>
                    </div>
                </div>
            `)
        }
    }

    observerElement('#storepoint-container').then(r => {
        observerElement('#storepoint-container #storepoint-results')
            .then(insertCustomElements)
            .then(() => {
                observerElement('#storepoint-container #storepoint-results', debounce(observerItems, 100))
                observerElement('#storepoint-map', debounce(observerPopup, 100))
            })
    })


    


    if (!sessionStorage.isPreviewTestRide) {
        fetchBuried('testride', 'pageview')
    }

    // 记录来过这个页面
    sessionStorage.isPreviewTestRide = 'isPreviewTestRide'

    window.onbeforeunload = () => {
        // 只要其中一个有值
        (last_select_city || last_select_store) && fetchBuried('testride', 'select', {
            last_select_city,
            last_select_store,
            select_city_count,
            select_store_count
        })
    }

    search.name && booknow(search.name)


    new Swiper('.test-ride-new-banner', {
        autoplay: {
            disableOnInteraction: false,
            pauseOnMouseEnter: true,
            delay: 10000,
        },
        loop: true,
        speed: 1000,
        pagination: {
            el: '.swiper-pagination',
            clickable: true
        }
    })
    </script>